<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>x402 Checkout Demo</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      margin-bottom: 20px;
    }
    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 32px 24px;
      text-align: center;
      color: white;
    }
    .card-header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }
    .card-header p {
      opacity: 0.9;
      font-size: 14px;
    }
    .card-content {
      padding: 32px 24px;
    }
    .step-indicator {
      text-align: center;
      margin-bottom: 24px;
    }
    .step-badge {
      display: inline-block;
      background: #e0e7ff;
      color: #4c51bf;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .product-card {
      border: 2px solid #e1e3e5;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }
    .product-image {
      width: 120px;
      height: 120px;
      background: #f6f6f7;
      border-radius: 12px;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
    }
    .product-title {
      font-size: 20px;
      font-weight: 600;
      color: #202223;
      margin-bottom: 12px;
    }
    .product-price {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 8px;
    }
    .price-crypto {
      font-size: 14px;
      color: #6d7175;
    }
    .input-group {
      margin-bottom: 20px;
    }
    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #202223;
      font-weight: 600;
      font-size: 14px;
    }
    .input-group input, .input-group select {
      width: 100%;
      padding: 14px;
      border: 2px solid #e1e3e5;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-primary:disabled {
      background: #c9cccf;
      cursor: not-allowed;
      transform: none;
    }
    .btn-success {
      background: #008060;
      color: white;
    }
    .wallet-info {
      background: #f6f6f7;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      text-align: center;
    }
    .wallet-address {
      font-family: monospace;
      font-size: 14px;
      color: #202223;
      word-break: break-all;
    }
    .payment-details {
      background: #1a1d21;
      color: #e3e8ee;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .payment-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
    }
    .payment-row:last-child {
      border-bottom: none;
    }
    .payment-label {
      opacity: 0.7;
    }
    .payment-value {
      font-family: monospace;
      font-weight: 600;
    }
    .success-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: #d1f7e5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }
    .order-summary {
      background: #f6f6f7;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e1e3e5;
    }
    .summary-row:last-child {
      border-bottom: none;
      font-weight: 600;
      font-size: 16px;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .hidden { display: none; }
    .back-link {
      display: inline-block;
      color: white;
      text-decoration: none;
      margin-bottom: 20px;
      font-size: 14px;
      opacity: 0.9;
    }
    .back-link:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="javascript:history.back()" class="back-link">‚Üê Back to Dashboard</a>

    <!-- Step 1: Product Selection -->
    <div id="step1" class="card">
      <div class="card-header">
        <h1>üõçÔ∏è x402 Checkout</h1>
        <p>Experience seamless crypto payments</p>
      </div>
      <div class="card-content">
        <div class="step-indicator">
          <span class="step-badge">Step 1: Select Product</span>
        </div>

        <div class="input-group">
          <label>Choose Demo Product</label>
          <select id="productSelect">
            <option value="">Select a product...</option>
            <option value="demo1">Premium Digital Service - $100</option>
            <option value="demo2">AI API Access Monthly - $50</option>
            <option value="demo3">Enterprise License - $500</option>
          </select>
        </div>

        <div id="productPreview" class="hidden">
          <div class="product-card">
            <div class="product-image" id="productEmoji">üéÅ</div>
            <div class="product-title" id="productTitle">Product Name</div>
            <div class="product-price" id="productPriceUSD">$100</div>
            <div class="price-crypto" id="productPriceCrypto">100 USDC</div>
          </div>
        </div>

        <button class="btn btn-primary" id="continueBtn" onclick="goToPayment()" disabled>
          Continue to Payment
        </button>
      </div>
    </div>

    <!-- Step 2: Connect Wallet & Pay -->
    <div id="step2" class="card hidden">
      <div class="card-header">
        <h1>üí≥ Payment</h1>
        <p>Connect wallet and complete payment</p>
      </div>
      <div class="card-content">
        <div class="step-indicator">
          <span class="step-badge">Step 2: Payment</span>
        </div>

        <div id="walletConnected" class="hidden">
          <div class="wallet-info">
            <p style="font-size: 12px; color: #6d7175; margin-bottom: 4px;">Connected Wallet</p>
            <div class="wallet-address" id="walletAddress"></div>
          </div>

          <div class="product-card">
            <div class="product-image" id="payProductEmoji">üéÅ</div>
            <div class="product-title" id="payProductTitle">Product Name</div>
            <div class="product-price" id="payProductPrice">100 USDC</div>
          </div>

          <div class="payment-details">
            <h3 style="margin-bottom: 16px; font-size: 14px; opacity: 0.7;">x402 v2 Payment Request</h3>
            <div class="payment-row">
              <span class="payment-label">Protocol</span>
              <span class="payment-value">x402 v2</span>
            </div>
            <div class="payment-row">
              <span class="payment-label">Recipient</span>
              <span class="payment-value" id="payRecipient">0x...</span>
            </div>
            <div class="payment-row">
              <span class="payment-label">Token</span>
              <span class="payment-value" id="payToken">USDC</span>
            </div>
            <div class="payment-row">
              <span class="payment-label">Amount</span>
              <span class="payment-value" id="payAmount">100</span>
            </div>
            <div class="payment-row">
              <span class="payment-label">Network</span>
              <span class="payment-value" id="payNetwork">Ethereum</span>
            </div>
          </div>

          <button class="btn btn-primary" onclick="signPayment()" id="payBtn">
            Sign Payment
          </button>
        </div>

        <div id="walletDisconnected">
          <p style="text-align: center; color: #6d7175; margin-bottom: 20px;">
            Connect your wallet to continue
          </p>
          <button class="btn btn-primary" onclick="connectWallet()">
            Connect Wallet
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Success -->
    <div id="step3" class="card hidden">
      <div class="card-header">
        <h1>‚úÖ Order Complete</h1>
        <p>Payment verified via x402 v2</p>
      </div>
      <div class="card-content">
        <div class="success-icon">‚úì</div>
        
        <div class="order-summary">
          <h3 style="margin-bottom: 16px; font-weight: 600;">Order Summary</h3>
          <div class="summary-row">
            <span>Order ID</span>
            <span id="orderId" style="font-family: monospace; font-size: 14px;">...</span>
          </div>
          <div class="summary-row">
            <span>Product</span>
            <span id="orderProduct">...</span>
          </div>
          <div class="summary-row">
            <span>Amount Paid</span>
            <span id="orderAmount">...</span>
          </div>
          <div class="summary-row">
            <span>Transaction</span>
            <span id="orderTx" style="font-family: monospace; font-size: 12px;">...</span>
          </div>
          <div class="summary-row">
            <span>Status</span>
            <span style="color: #008060;">‚úì Verified</span>
          </div>
        </div>

        <button class="btn btn-success" onclick="location.reload()">
          Make Another Purchase
        </button>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const shop = urlParams.get('shop');

    // Demo products
    const products = {
      demo1: {
        id: 'prod_001',
        title: 'Premium Digital Service',
        emoji: 'üíé',
        priceUSD: 100,
        priceCrypto: '100000000', // 100 USDC (6 decimals)
        priceDisplay: '100 USDC'
      },
      demo2: {
        id: 'prod_002',
        title: 'AI API Access Monthly',
        emoji: 'ü§ñ',
        priceUSD: 50,
        priceCrypto: '50000000',
        priceDisplay: '50 USDC'
      },
      demo3: {
        id: 'prod_003',
        title: 'Enterprise License',
        emoji: 'üè¢',
        priceUSD: 500,
        priceCrypto: '500000000',
        priceDisplay: '500 USDC'
      }
    };

    let selectedProduct = null;
    let paymentRequest = null;
    let walletAddress = null;

    // Product selection
    document.getElementById('productSelect').addEventListener('change', (e) => {
      const productId = e.target.value;
      if (productId && products[productId]) {
        selectedProduct = products[productId];
        showProductPreview();
        document.getElementById('continueBtn').disabled = false;
      } else {
        document.getElementById('productPreview').classList.add('hidden');
        document.getElementById('continueBtn').disabled = true;
      }
    });

    function showProductPreview() {
      document.getElementById('productEmoji').textContent = selectedProduct.emoji;
      document.getElementById('productTitle').textContent = selectedProduct.title;
      document.getElementById('productPriceUSD').textContent = `$${selectedProduct.priceUSD}`;
      document.getElementById('productPriceCrypto').textContent = selectedProduct.priceDisplay;
      document.getElementById('productPreview').classList.remove('hidden');
    }

    async function goToPayment() {
      try {
        // Generate payment request
        const response = await fetch('/api/payment/request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shop,
            productId: selectedProduct.id,
            productTitle: selectedProduct.title,
            amount: selectedProduct.priceCrypto
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to generate payment request');
        }

        paymentRequest = await response.json();

        // Show payment step
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');

        // Update payment UI
        document.getElementById('payProductEmoji').textContent = selectedProduct.emoji;
        document.getElementById('payProductTitle').textContent = selectedProduct.title;
        document.getElementById('payProductPrice').textContent = selectedProduct.priceDisplay;
        
        document.getElementById('payRecipient').textContent = 
          paymentRequest.recipient.slice(0, 10) + '...' + paymentRequest.recipient.slice(-8);
        document.getElementById('payToken').textContent = 'USDC';
        document.getElementById('payAmount').textContent = selectedProduct.priceDisplay;
        document.getElementById('payNetwork').textContent = paymentRequest.network;

      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        alert('Please install MetaMask to continue');
        return;
      }

      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const accounts = await provider.send("eth_requestAccounts", []);
        walletAddress = accounts[0];

        document.getElementById('walletAddress').textContent = 
          walletAddress.slice(0, 10) + '...' + walletAddress.slice(-8);
        
        document.getElementById('walletDisconnected').classList.add('hidden');
        document.getElementById('walletConnected').classList.remove('hidden');

      } catch (error) {
        alert('Failed to connect wallet: ' + error.message);
      }
    }

    async function signPayment() {
      const btn = document.getElementById('payBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span>Processing...';

      try {
        // Simulate transaction (in real scenario, user would sign actual transaction)
        const txHash = '0x' + Array.from({length: 64}, () => 
          Math.floor(Math.random() * 16).toString(16)
        ).join('');

        // Verify payment
        const response = await fetch('/api/payment/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            shop,
            txHash,
            fromAddress: walletAddress,
            amount: selectedProduct.priceCrypto,
            productId: selectedProduct.id,
            productTitle: selectedProduct.title
          })
        });

        if (!response.ok) {
          throw new Error('Payment verification failed');
        }

        const result = await response.json();

        if (result.verified) {
          // Show success
          document.getElementById('step2').classList.add('hidden');
          document.getElementById('step3').classList.remove('hidden');

          document.getElementById('orderId').textContent = result.paymentId;
          document.getElementById('orderProduct').textContent = selectedProduct.title;
          document.getElementById('orderAmount').textContent = selectedProduct.priceDisplay;
          document.getElementById('orderTx').textContent = 
            txHash.slice(0, 10) + '...' + txHash.slice(-8);
        } else {
          throw new Error('Payment not verified');
        }

      } catch (error) {
        alert('Payment failed: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Sign Payment';
      }
    }

    // Auto-connect if wallet already connected
    window.addEventListener('load', async () => {
      if (typeof window.ethereum !== 'undefined') {
        try {
          const provider = new ethers.providers.Web3Provider(window.ethereum);
          const accounts = await provider.listAccounts();
          if (accounts.length > 0) {
            walletAddress = accounts[0];
          }
        } catch (error) {
          console.log('Wallet not connected');
        }
      }
    });
  </script>
</body>
</html>